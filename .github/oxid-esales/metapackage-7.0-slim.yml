install:
  method: 'script'
  git:
    shop_url: 'https://github.com/{{ .Github.Repository }}.git'
    shop_ref: 'b-7.0'
  composer:
    transform: |
      {
          "config": {
              "github-protocols": ["https"],
              "allow-plugins":{
                "oxid-esales/oxideshop-composer-plugin":true,
                "oxid-esales/oxideshop-unified-namespace-generator":true
              }
          },
          "preferred-install": {
            "oxid-esales/*": "source",
            "oxid-professional-services/*": "source",
            "ddoe/*": "source",
            "makaira/*": "source"
          },
          "require": {
            "twig/twig": "v3.8.0"
          },
          "require-dev":{
              "oxid-esales/codeception-modules":"{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/codeception-page-objects":"{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/developer-tools":"{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/oxideshop-ide-helper":"{{ .Data.global.composer.dev_ref }}",
              "codeception/codeception": "^5.0",
              "codeception/module-asserts": "^3.0",
              "codeception/module-db": "^3.0",
              "codeception/module-filesystem": "^3.0",
              "codeception/module-webdriver": "^3.1",
              "composer/composer": "^2.0",
              "incenteev/composer-parameter-handler": "^v2.1.4",
              "mikey179/vfsstream": "~1.6.8",
              "phpspec/prophecy-phpunit": "^v2.0.1",
              "phpunit/phpunit": "^9.1.1",
              "squizlabs/php_codesniffer": "^3.5.4"
          },
          "repositories": {
            "oxid-esales/oxideshop-ce": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/oxideshop_ce.git"
            },
            "oxid-esales/gdpr-optin-module": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/gdpr-optin-module.git"
            },
            "oxid-esales/oxideshop-composer-plugin": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/oxideshop_composer_plugin.git"
            },
            "oxid-esales/oxideshop-doctrine-migration-wrapper": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/oxideshop-doctrine-migration-wrapper.git"
            },
            "oxid-esales/oxideshop-facts": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/oxideshop-facts.git"
            },
            "oxid-esales/oxideshop-unified-namespace-generator": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/oxideshop-unified-namespace-generator.git"
            },
            "oxid-esales/twig-component": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/twig-component.git"
            },
            "oxid-professional-services/usercentrics": {
              "type": "git",
              "url": "https://github.com/OXID-eSales/usercentrics.git"
            },
            "makaira/oxid-connect-essential": {
              "type": "git",
              "url": "https://github.com/MakairaIO/oxid-connect-essential.git"
            }
          },
          "autoload-dev":{
              "psr-4":{
                "OxidEsales\\EshopCommunity\\Tests\\":"./vendor/oxid-esales/oxideshop-ce/tests",
                "OxidEsales\\ComposerPlugin\\Tests\\": "vendor/oxid-esales/oxideshop-composer-plugin/tests/",
                "OxidEsales\\UnifiedNameSpaceGenerator\\Tests\\": "./vendor/oxid-esales/oxideshop-unified-namespace-generator/tests",
                "OxidEsales\\DemoDataInstaller\\Tests\\": "./vendor/oxid-esales/oxideshop-demodata-installer/tests/",
                "OxidEsales\\DoctrineMigrationWrapper\\Tests\\": "./vendor/oxid-esales/oxideshop-doctrine-migration-wrapper/tests",
                "OxidEsales\\Facts\\Tests\\": "./vendor/oxid-esales/oxideshop-facts/tests/",
                "OxidEsales\\Twig\\Tests\\": "./vendor/oxid-esales/twig-component/tests",
                "OxidEsales\\GdprOptinModule\\Tests\\": "./vendor/oxid-esales/gdpr-optin-module/tests/",
                "OxidProfessionalServices\\Usercentrics\\Tests\\": "./vendor/oxid-professional-services/usercentrics/tests"
              }
          },
          "bin":[
              "bin/oe-console"
          ]
      }

  custom_script: |
    # Copy test scripts for components/modules that are not yet using them
    for MODULE in oxid-esales/oxideshop-composer-plugin oxid-esales/oxideshop-demodata-ce \
                  oxid-esales/oxideshop-doctrine-migration-wrapper oxid-esales/oxideshop-facts \
                  oxid-esales/oxideshop-unified-namespace-generator oxid-professional-services/usercentrics \
                  makaira/oxid-connect-essential
    do
      for SCRIPT in $(find tests/scripts); do
        BASE=$(basename "${SCRIPT}")
        if [ ! -f vendor/${MODULE}/${BASE} ]; then
          cp "${SCRIPT}" "vendor/${MODULE}/${BASE}"
        fi
      done
    done

  custom_script_container: |
    # Activate all modules
    if [ -f 'bin/oe-console' ]; then
        OE_CONSOLE='bin/oe-console'
    else
        if [ -f 'vendor/bin/oe-console' ]; then
        OE_CONSOLE='vendor/bin/oe-console'
        else
            error "Can't find oe-console in bin or vendor/bin!"
        fi
    fi
    for MODULE in oegdproptin oxps_usercentrics makaira_oxid-connect-essential ddoemedialibrary ddoewysiwyg; do
      ${OE_CONSOLE} oe:module:activate "${MODULE}"
    done
    ${OE_CONSOLE} oe:setup:demodata

runscript:
  matrix:
    script: |
      [
        "shop:~/unit.sh",
        "shop:~/integration.sh",
        "shop:~/codeception.sh",
        "gdpr:phpunit",
        "gdpr:codeception",
        "usercentrics:~/unit.sh",
        "usercentrics:~/integration.sh",
        "usercentrics:~/codeception.sh",
        "makaira:~/unit.sh",
        "makaira:~/integration.sh",
        "ddoe_wysiwyg:~/integration.sh",
        "ddoe_wysiwyg_codeception_twig:~/codeception.sh"
      ]
  container:
    # yamllint disable-line rule:line-length
    options: '-e THEME_ID=apex -e TEST_SUITE=/var/www/vendor/oxid-esales/oxideshop-ce/tests -e MODULE_IDS=oegdproptin,oxps_usercentrics,makaira_oxid-connect-essential,ddoewysiwyg'
  shop: &shop
    path: 'vendor/oxid-esales/oxideshop-ce'
    container:
      # yamllint disable-line rule:line-length
      options: '-e XDEBUG_MODE=coverage -e GITHUB_EVENT_NAME={{ .Github.EventName }} -e GITHUB_BASE_REF={{ .Github.BaseRef }} -e GITHUB_REF={{ .Github.Ref }} -e GITHUB_REF_NAME={{ .Github.RefName }} -e THEME_ID=apex -e TEST_SUITE=/var/www/vendor/oxid-esales/oxideshop-ce/tests -e MODULE_IDS=oegdproptin,oxps_usercentrics,makaira_oxid-connect-essential,ddoewysiwyg'
  gdpr:
    path: 'vendor/oxid-esales/gdpr-optin-module'
  usercentrics:
    path: 'vendor/oxid-professional-services/usercentrics'
  makaira:
    path: 'vendor/makaira/oxid-connect-essential'
  ddoe_wysiwyg:
    path: 'vendor/ddoe/wysiwyg-editor-module'
  ddoe_wysiwyg_codeception_twig:
    path: 'vendor/ddoe/wysiwyg-editor-module'
  composer:
    transform: |
      {
        "require":     {
            "oxid-esales/twig-theme": "dev-b-7.0.x"
        }
      }

runslim:
  <<: *runscript
  matrix:
    script: |
    [
      "gdpr:phpcs-report",
      "gdpr:phpstan-report",
      "gdpr:phpmd-report",
    ]

sonarcloud:
  matrix:
    testplan: 'skip'

finish:
  slack_title: 'Metapackage CE (7.0 slim) on {{ .Github.Repository }} by {{ .Github.Actor }}'
